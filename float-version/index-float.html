<!DOCTYPE html> 
<html lang="uk">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Rosea ‚Äî –õ–∞–± 7 (Float)</title>
  <link rel="stylesheet" href="styles-float.css">
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Montserrat:wght@300;400;500&family=Cormorant+Garamond:wght@400;500&display=swap" rel="stylesheet">
</head>
<body>
  <div class="wrap">
    <div class="board">

      <header class="b1 banner" role="banner">
        <h2>Rosea </h2>
      </header>

      <aside class="b2 home-left" role="complementary">
        <div class="left-text">
          –ü–æ–¥–∞—Ä—É–π –±—É–∫–µ—Ç <br>
          –¥–ª—è <span class="highlight">special</span> –ª—é–¥–∏–Ω–∏ <br>
          —ñ –∑—Ä–æ–±–∏ —ó—ó –¥–µ–Ω—å <br>
          –æ—Å–æ–±–ª–∏–≤–∏–º
        </div>
      </aside>
      
      <div class="b4" role="complementary">
        <nav role="navigation" aria-label="–ì–æ–ª–æ–≤–Ω–µ –º–µ–Ω—é">
          <ul>
            <li><a class="active" href="index-float.html">–ì–æ–ª–æ–≤–Ω–∞</a></li>
            <li><a href="page2-float.html">–ö–∞—Ç–∞–ª–æ–≥</a></li>
            <li><a href="page3-float.html">–ü—Ä–æ –Ω–∞—Å</a></li>
            <li><a href="page4-float.html">–ì–∞–ª–µ—Ä–µ—è</a></li>
            <li><a href="page5-float.html">–ö–æ–Ω—Ç–∞–∫—Ç–∏</a></li>
          </ul>
        </nav>
      </div>

      <div class="b6" role="note">
        –ü–æ—Ä–∞–¥–∞ –¥–Ω—è: –¥–æ–¥–∞–π—Ç–µ –∫—ñ–ª—å–∫–∞ –∫–≤—ñ—Ç—ñ–≤ —É —Å–≤—ñ–π –¥—ñ–º, –Ω–∞—Å—Ç—Ä—ñ–π –∑–º—ñ–Ω–∏—Ç—å—Å—è üåø
      </div>

      <main class="b5" role="main">
        <div class="love-block"> 
            <h1>–¢–ò + ROSEA</h1>
            <button id="play-btn" onclick="openWorkArea()">‚ñ∂ PLAY ANIMATION</button>
        </div>

        <div class="gallery-block" id="main-content">
            <p>–¢—É—Ç –∑–≤–∏—á–∞–π–Ω–∏–π –∫–æ–Ω—Ç–µ–Ω—Ç. –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å PLAY –∑–≤–µ—Ä—Ö—É.</p>
            <div id="results-container">
                <table id="results-table">
                    <thead>
                        <tr>
                            <th colspan="2">–°–ø–æ—Å—ñ–± 1 (–ú–∏—Ç—Ç—î–≤–æ / Server)</th>
                            <th colspan="2">–°–ø–æ—Å—ñ–± 2 (LocalStorage / Batch)</th>
                        </tr>
                        <tr>
                            <th>–ü–æ–¥—ñ—è</th>
                            <th>–ß–∞—Å (Srv)</th>
                            <th>–ü–æ–¥—ñ—è</th>
                            <th>–ß–∞—Å (Local -> Srv)</th>
                        </tr>
                    </thead>
                    <tbody id="results-body"></tbody>
                </table>
            </div>
        </div>

        <div id="work-area">
            <div class="controls-panel">
                <span id="log-msg" class="log-message">–û—á—ñ–∫—É–≤–∞–Ω–Ω—è...</span>
                <div>
                    <button id="btn-start" class="control-btn btn-start" onclick="startAnimation()">START</button>
                    <button id="btn-stop" class="control-btn btn-stop" onclick="stopAnimation()" style="display:none;">STOP</button>
                    <button id="btn-reload" class="control-btn btn-reload" onclick="reloadAnimation()" style="display:none;">RELOAD</button>
                    <button class="control-btn btn-close" onclick="closeWorkArea()">CLOSE</button>
                </div>
            </div>
            
            <div id="anim-area">
                <div class="anim-bg">
                    <div class="quadrant q1"></div>
                    <div class="quadrant q2"></div>
                    <div class="quadrant q3"></div>
                    <div class="quadrant q4"></div>
                </div>
                <div id="anim-obj"></div>
            </div>
        </div>
      </main>

      <footer class="b7" role="contentinfo">
        <h2>Rosea</h2>
        <h3>Lab 7</h3>
      </footer>

    </div>
  </div>

  <script>
    const obj = document.getElementById('anim-obj');
    const animArea = document.getElementById('anim-area');
    const msgBox = document.getElementById('log-msg');
    
    let timer = null;
    let x, y;
    let stepSize = 1;
    let currentDir = 0;
    let movesInDir = 0;
    let stepsLimit = 1;
    let turnCounter = 0;
    
    let visitedQuadrants = new Set();
    let eventCount = 0;
    let batchEvents = []; 

    function initObj() {
        x = animArea.clientWidth / 2 - 10;
        y = animArea.clientHeight / 2 - 10;
        obj.style.left = x + 'px';
        obj.style.top = y + 'px';
        
        stepSize = 1;
        currentDir = 0; 
        movesInDir = 0;
        stepsLimit = 5;
        turnCounter = 0;
        visitedQuadrants.clear();
        batchEvents = [];
        eventCount = 0;
        
        fetch('server.php', { method: 'DELETE' });
        localStorage.setItem('localEvents', JSON.stringify([]));
        
        logEvent("–ì–æ—Ç–æ–≤–Ω—ñ—Å—Ç—å –¥–æ —Å—Ç–∞—Ä—Ç—É");
    }

    function openWorkArea() {
        document.getElementById('work-area').style.display = 'block';
        document.getElementById('main-content').style.visibility = 'hidden';
        initObj();
    }

    function closeWorkArea() {
        stopAnimation();
        document.getElementById('work-area').style.display = 'none';
        document.getElementById('main-content').style.visibility = 'visible';
        showResults();
    }

    function startAnimation() {
        document.getElementById('btn-start').style.display = 'none';
        document.getElementById('btn-stop').style.display = 'inline-block';
        
        logEvent("Start pressed. Animation started.");

        timer = setInterval(() => {
            moveStep();
        }, 30);
    }

    function stopAnimation() {
        if(timer) clearInterval(timer);
        timer = null;
        document.getElementById('btn-stop').style.display = 'none';
        document.getElementById('btn-reload').style.display = 'inline-block';
        logEvent("Animation stopped.");
        sendBatchData();
    }

    function reloadAnimation() {
        document.getElementById('btn-reload').style.display = 'none';
        document.getElementById('btn-start').style.display = 'inline-block';
        initObj();
    }

    function moveStep() {
        switch(currentDir) {
            case 0: x -= stepSize; break;
            case 1: y -= stepSize; break;
            case 2: x += stepSize; break;
            case 3: y += stepSize; break;
        }
        
        movesInDir++;
        
        if (movesInDir >= stepsLimit) {
            currentDir = (currentDir + 1) % 4;
            movesInDir = 0;
            turnCounter++;
            if (turnCounter % 2 === 0) {
                stepsLimit += 5;
                stepSize += 0.2;
            }
        }

        if(x < 0) x = 0;
        if(y < 0) y = 0;
        if(x > animArea.clientWidth - 20) x = animArea.clientWidth - 20;
        if(y > animArea.clientHeight - 20) y = animArea.clientHeight - 20;

        obj.style.left = x + 'px';
        obj.style.top = y + 'px';

        checkQuadrants();
        
        logEvent(`Step: x=${Math.round(x)}, y=${Math.round(y)}`);
    }

    function checkQuadrants() {
        const W = animArea.clientWidth;
        const H = animArea.clientHeight;
        let q = "";
        
        let cx = x + 10;
        let cy = y + 10;

        if (cx < W/2 && cy < H/2) q = "Q1 (Top-Left)";
        else if (cx >= W/2 && cy < H/2) q = "Q2 (Top-Right)";
        else if (cx < W/2 && cy >= H/2) q = "Q3 (Bottom-Left)";
        else q = "Q4 (Bottom-Right)";

        if (!visitedQuadrants.has(q)) {
            visitedQuadrants.add(q);
            logEvent(`Entered ${q}`);
            
            if (visitedQuadrants.size === 4) {
                stopAnimation();
                logEvent("All quadrants visited! Auto-Stop.");
                alert("–ê–Ω—ñ–º–∞—Ü—ñ—é –∑–∞–≤–µ—Ä—à–µ–Ω–æ! –í—Å—ñ –∫–≤–∞–¥—Ä–∞–Ω—Ç–∏ –ø—Ä–æ–π–¥–µ–Ω–æ.");
            }
        }
    }

    function logEvent(text) {
        eventCount++;
        const now = new Date();
        const timeStr = now.toLocaleTimeString() + "." + now.getMilliseconds();
        
        msgBox.innerText = `Last: ${text} (${timeStr})`;

        const eventObj = {
            id: eventCount,
            time: timeStr,
            details: text
        };

        fetch('server.php', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(eventObj)
        }).catch(err => console.error("Server error:", err));

        batchEvents.push(eventObj);
        localStorage.setItem('localEvents', JSON.stringify(batchEvents));
    }

    function sendBatchData() {
        const data = { batch: batchEvents };
        fetch('server.php', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        }).then(res => res.json())
          .then(d => console.log("Batch saved:", d));
    }

    function showResults() {
        const tbody = document.getElementById('results-body');
        tbody.innerHTML = '<tr><td colspan="4">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö...</td></tr>';
        document.getElementById('results-table').style.display = 'table';

        fetch('server.php')
            .then(res => res.json())
            .then(data => {
                tbody.innerHTML = '';
                
                const realtimeData = data.filter(e => e.method === 'realtime');
                const batchData = data.filter(e => e.method === 'batch');
                
                const maxLen = Math.max(realtimeData.length, batchData.length);

                for(let i=0; i<maxLen; i++) {
                    const r = realtimeData[i] || {details: '-', server_save_time: '-'};
                    const b = batchData[i] || {details: '-', server_save_time: '-'};
                    
                    const row = `<tr>
                        <td>${r.details}</td>
                        <td>${r.server_save_time}</td>
                        <td>${b.details}</td>
                        <td>${b.time} -> ${b.server_save_time}</td>
                    </tr>`;
                    tbody.innerHTML += row;
                }
            });
    }
  </script>
</body>
</html>